#!groovy

@Library("Infrastructure")

def type = "angular"
def product = "darts"
def component = "portal"

def branchesToSync = ['demo', 'perftest']

static LinkedHashMap<String, Object> secret(String secretName, String envVar) {
  [
    $class     : 'AzureKeyVaultSecret',
    secretType : 'Secret',
    name       : secretName,
    version    : '',
    envVariable: envVar,
  ]
}

def secrets = [
  'darts-stg': [
    secret('DartsExternalUsersTestPassword', 'EXTERNAL_AUTOMATION_PASSWORD'),
    secret('DartsAdminUserName', 'TEST_ADMIN_USERNAME'),
  ],
]

def yarnBuilder = new uk.gov.hmcts.contino.YarnBuilder(this)

withPipeline(type, product, component) {
  loadVaultSecrets(secrets)

  echo "BRANCH_NAME=${env.BRANCH_NAME} CHANGE_ID=${env.CHANGE_ID} ENVIRONMENT=${env.ENVIRONMENT} PIPELINE_ENV=${env.env}"
  echo "TEST_ADMIN_USERNAME: ${env.TEST_ADMIN_USERNAME}" 

  env.CYPRESS_AUTOMATION_PASSWORD = env.EXTERNAL_AUTOMATION_PASSWORD

  echo "CYPRESS_AUTOMATION_PASSWORD length: ${env.CYPRESS_AUTOMATION_PASSWORD?.length()}"
  echo "EXTERNAL_AUTOMATION_PASSWORD length: ${env.EXTERNAL_AUTOMATION_PASSWORD?.length()}"

  if (!env.EXTERNAL_AUTOMATION_PASSWORD?.trim()) {
    error """Key Vault secret not loaded.
    Tried: darts-${env.env ?: env.ENVIRONMENT} (via override), darts-stg, darts-staging
    Secret: DartsExternalUsersTestPassword
    EnvVar: EXTERNAL_AUTOMATION_PASSWORD
    Check vault name, secret name (case-sensitive), library env mapping, and access."""
  }


  afterSuccess('build') {
    sh 'echo "EXTERNAL_AUTOMATION_PASSWORD length: ${#EXTERNAL_AUTOMATION_PASSWORD}"'
    sh 'echo "CYPRESS_AUTOMATION_PASSWORD length: ${#CYPRESS_AUTOMATION_PASSWORD}"'
  }

  before('smokeTest:dev') {
    env.CYPRESS_AUTOMATION_PASSWORD = env.EXTERNAL_AUTOMATION_PASSWORD
    sh 'echo "[smokeTest:dev] AUT length: ${#AUTOMATION_PASSWORD}" || true'
    sh 'echo "[smokeTest:dev] CYP length: ${#CYPRESS_AUTOMATION_PASSWORD}" || true'
    sh 'node -e "console.log(\'Node sees CYP len:\',(process.env.CYPRESS_AUTOMATION_PASSWORD||\'\').length)"'
}

  enableSlackNotifications('#darts-builds')
  disableCleanupOfHelmReleaseOnFailure()

  afterAlways('smokeTest:dev') {
    steps.archiveArtifacts allowEmptyArchive: true, artifacts: 'smoke-output/**/*'
    steps.archiveArtifacts allowEmptyArchive: true, artifacts: 'cypress/screenshots/**/*'
    steps.archiveArtifacts allowEmptyArchive: true, artifacts: 'cypress/videos/**/*'

  }

  afterAlways('smokeTest:stg') {
    steps.archiveArtifacts allowEmptyArchive: true, artifacts: 'smoke-output/**/*'
    steps.archiveArtifacts allowEmptyArchive: true, artifacts: 'cypress/screenshots/**/*'
    steps.archiveArtifacts allowEmptyArchive: true, artifacts: 'cypress/videos/**/*'
  }

  afterAlways('functionalTest:dev') {
    steps.archiveArtifacts allowEmptyArchive: true, artifacts: 'functional-output/**/*'
    steps.archiveArtifacts allowEmptyArchive: true, artifacts: 'cypress/screenshots/**/*'
    steps.archiveArtifacts allowEmptyArchive: true, artifacts: 'cypress/videos/**/*'

    publishHTML target: [
      allowMissing         : true,
      alwaysLinkToLastBuild: true,
      keepAll              : true,
      reportDir            : "functional-output/functional",
      reportFiles          : "functional-test-result.html",
      reportName           : "Functional Test Report"
    ]
  }

  afterAlways('functionalTest:stg') {
    steps.archiveArtifacts allowEmptyArchive: true, artifacts: 'functional-output/**/*'
    steps.archiveArtifacts allowEmptyArchive: true, artifacts: 'cypress/screenshots/**/*'
    steps.archiveArtifacts allowEmptyArchive: true, artifacts: 'cypress/videos/**/*'

    publishHTML target: [
      allowMissing         : true,
      alwaysLinkToLastBuild: true,
      keepAll              : true,
      reportDir            : "functional-output/functional",
      reportFiles          : "functional-test-result.html",
      reportName           : "Functional Test Report"
    ]
  }

  syncBranchesWithMaster(branchesToSync)
}