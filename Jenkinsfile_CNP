#!groovy

@Library('Infrastructure')

def type = "angular"
def product = "darts"
def component = "portal"

def branchesToSync = ['demo', 'perftest']

static LinkedHashMap<String, Object> secret(String secretName, String envVar) {
  [
    $class     : 'AzureKeyVaultSecret',
    secretType : 'Secret',
    name       : secretName,
    version    : '',
    envVariable: envVar,
  ]
}

def vaultOverrides = [
  'preview': 'stg',
  'dev': 'stg'
]

def secrets = [
  'darts-${env}': [
    secret('DartsExternalUsersTestPassword', 'CYPRESS_AUTOMATION_PASSWORD'),
  ],
]

def yarnBuilder = new uk.gov.hmcts.contino.YarnBuilder(this)

withPipeline(type, product, component) {
  overrideVaultEnvironments(vaultOverrides)
  loadVaultSecrets(secrets)

  enableSlackNotifications('#darts-builds')
  disableCleanupOfHelmReleaseOnFailure()

  // before('smoketest:dev') {
  //   if (!env.CYPRESS_AUTOMATION_PASSWORD?.trim()) {
  //     env.CYPRESS_AUTOMATION_PASSWORD = env.EXTERNAL_AUTOMATION_PASSWORD
  //     steps.echo "Set CYPRESS_AUTOMATION_PASSWORD from EXTERNAL_AUTOMATION_PASSWORD"
  //   }
  // }

  // before('smoketest:stg') {
  //   if (!env.CYPRESS_AUTOMATION_PASSWORD?.trim()) {
  //     env.CYPRESS_AUTOMATION_PASSWORD = env.EXTERNAL_AUTOMATION_PASSWORD
  //     steps.echo "Set CYPRESS_AUTOMATION_PASSWORD from EXTERNAL_AUTOMATION_PASSWORD"
  //   }
  // }

  afterAlways('smoketest:dev') {
    steps.archiveArtifacts allowEmptyArchive: true, artifacts: 'smoke-output/**/*'
    steps.archiveArtifacts allowEmptyArchive: true, artifacts: 'cypress/screenshots/**/*'
    steps.archiveArtifacts allowEmptyArchive: true, artifacts: 'cypress/videos/**/*'
  }

  afterAlways('smoketest:stg') {
    steps.archiveArtifacts allowEmptyArchive: true, artifacts: 'smoke-output/**/*'
    steps.archiveArtifacts allowEmptyArchive: true, artifacts: 'cypress/screenshots/**/*'
    steps.archiveArtifacts allowEmptyArchive: true, artifacts: 'cypress/videos/**/*'
  }

  afterAlways('functionalTest:dev') {
    steps.archiveArtifacts allowEmptyArchive: true, artifacts: 'functional-output/**/*'
    steps.archiveArtifacts allowEmptyArchive: true, artifacts: 'cypress/screenshots/**/*'
    steps.archiveArtifacts allowEmptyArchive: true, artifacts: 'cypress/videos/**/*'

    publishHTML target: [
      allowMissing         : true,
      alwaysLinkToLastBuild: true,
      keepAll              : true,
      reportDir            : "functional-output/functional",
      reportFiles          : "functional-test-result.html",
      reportName           : "Functional Test Report"
    ]
  }

  afterAlways('functionalTest:stg') {
    steps.archiveArtifacts allowEmptyArchive: true, artifacts: 'functional-output/**/*'
    steps.archiveArtifacts allowEmptyArchive: true, artifacts: 'cypress/screenshots/**/*'
    steps.archiveArtifacts allowEmptyArchive: true, artifacts: 'cypress/videos/**/*'

    publishHTML target: [
      allowMissing         : true,
      alwaysLinkToLastBuild: true,
      keepAll              : true,
      reportDir            : "functional-output/functional",
      reportFiles          : "functional-test-result.html",
      reportName           : "Functional Test Report"
    ]
  }

  syncBranchesWithMaster(branchesToSync)
}