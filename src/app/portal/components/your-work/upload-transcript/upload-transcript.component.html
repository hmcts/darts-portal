<app-breadcrumb>
  <ng-container *breadcrumb="['/work']">Your work</ng-container>
  <ng-container *breadcrumb>{{ requestId }}</ng-container>
</app-breadcrumb>
@if (vm$ | async; as vm) {
  <app-validation-error-summary [errors]="errors"></app-validation-error-summary>

  <app-reporting-restriction
    class="margin-bottom"
    [restrictions]="vm.reportingRestrictions"
    [hearingId]="vm.hearingId"
  ></app-reporting-restriction>

  <app-govuk-heading>Transcript request</app-govuk-heading>

  <app-details-table title="Case details" [details]="vm.caseDetails" />

  <app-details-table title="Request details" [details]="vm.hearingDetails" />

  @if (requestStatus !== 'COMPLETED' && vm.status !== 'Complete') {
    <button
      id="get-audio-button"
      class="govuk-button govuk-button--secondary"
      [routerLink]="vm.hearingId ? ['/case', vm.caseId, 'hearing', vm.hearingId] : ['/case', vm.caseId]"
      [queryParams]="vm.getAudioQueryParams"
    >
      Get audio for this request
    </button>

    @if (!isManualRequest) {
      <p class="govuk-body">
        This is an automated request. Send the transcript using your usual process for an automated request. Then, mark
        the request as complete. If a transcript canâ€™t be provided, select Unfulfilled and choose a reason.
      </p>
    }

    <fieldset class="govuk-fieldset margin-bottom">
      <legend class="govuk-fieldset__legend govuk-fieldset__legend--s">Outcome</legend>

      <div class="govuk-radios">
        <div class="govuk-radios__item">
          <input
            class="govuk-radios__input"
            id="outcome-complete"
            name="outcome"
            type="radio"
            [formControl]="outcomeControl"
            [value]="'complete'"
            (change)="onOutcomeChanged()"
          />
          <label class="govuk-label govuk-radios__label" for="outcome-complete">Complete</label>
        </div>
        <div class="govuk-radios__item">
          <input
            class="govuk-radios__input"
            id="outcome-unfulfilled"
            name="outcome"
            type="radio"
            [formControl]="outcomeControl"
            [value]="'unfulfilled'"
            (change)="onOutcomeChanged()"
          />
          <label class="govuk-label govuk-radios__label" for="outcome-unfulfilled">Unfulfilled</label>
        </div>
      </div>
    </fieldset>

    @if (isManualRequest && !isUnfulfilled) {
      <app-file-upload
        [formControl]="fileControl"
        [isInvalid]="this.fileControl.invalid && this.isSubmitted"
        [errorMessage]="errors.length ? errors[0].message : ''"
        label="Upload transcript file"
        fileSizeHint="Maximum file size 10MB"
        fileTypeHint="Compatible file formats are .txt, .dot, .dotx, .doc, .docx, .pdf, .rtf, .zip or .odt"
        allowedFileTypes=".txt,.dot,.dotx,.doc,.docx,.pdf,.rtf,.zip,.odt"
      ></app-file-upload>
    }

    @if (isUnfulfilled) {
      <div class="govuk-form-group" [class.govuk-form-group--error]="isSubmitted && reasonControl.invalid">
        <label class="govuk-label" for="reason">Reason</label>
        @if (isSubmitted && reasonControl.hasError('required')) {
          <p class="govuk-error-message">
            <span class="govuk-visually-hidden">Error: </span>{{ getErrorMessage('reason', reasonControl.errors) }}
          </p>
        }
        <select id="reason" class="govuk-select" [formControl]="reasonControl" (change)="onReasonChanged()">
          <option value="" disabled selected>Select a reason</option>
          @for (r of REASONS; track r) {
            <option [ngValue]="r">{{ REASON_DISPLAY[r] }}</option>
          }
        </select>
      </div>

      @if (reasonControl.value === 'other') {
        <div class="govuk-form-group" [class.govuk-form-group--error]="isSubmitted && detailsControl.invalid">
          <label class="govuk-label" for="details">Comment</label>
          @if (isSubmitted && detailsControl.invalid) {
            <p class="govuk-error-message">
              <span class="govuk-visually-hidden">Error: </span>{{ getErrorMessage('details', detailsControl.errors) }}
            </p>
          }
          <app-govuk-textarea
            [control]="detailsControl"
            [id]="'details'"
            name="details"
            ariaDescribedBy="details-label"
            [maxCharacterLimit]="200"
            [isInvalid]="isSubmitted && detailsControl.invalid"
          />
        </div>
      }
    }

    <div class="govuk-button-group">
      <button id="submit-button" class="govuk-button" [disabled]="isUploading" (click)="onComplete()">
        {{ submitLabel }}
      </button>
      <a routerLink="../" class="govuk-link">Cancel</a>
    </div>
  }
} @else {
  <app-loading />
}
